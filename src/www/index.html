<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Adjudicaciones</title>
    </head>
    <body>
        <script type="text/javascript" src="/vendors/d3.v3.min.js"></script>
        <script type="text/javascript">
         d3.json("/data/adjudicaciones.json", function(json) {
             var by_ministerio = d3.nest()
                                   .key(function(d) { return d.e; })
                                   .rollup(function(adjudicaciones) {
                                       var money = {};
                                       adjudicaciones.forEach(function(adjudicacion) {
                                           if(!!adjudicacion.m && !isNaN(adjudicacion.m.valor)) {
                                               if(!!!money[adjudicacion.m.moneda]) {
                                                   money[adjudicacion.m.moneda] = adjudicacion.m.valor;
                                               } else {
                                                   money[adjudicacion.m.moneda] += adjudicacion.m.valor;
                                               }
                                           }
                                       });
                                       
                                       return {
                                           'adjudicaciones': adjudicaciones.length,
                                           'money':  money
                                       };
                                   })
                                   .entries(json)
                                   .sort(function(x,y) {
                                       if(x.values.adjudicaciones >= y.values.adjudicaciones) {
                                           return -1;
                                       } else if (x.values.adjudicaciones < y.values.adjudicaciones) {
                                           return 1;
                                       } else {
                                           return 0;
                                       }
                                   });
             
             d3.select('body')
               .data(by_ministerio)
               .enter()
               .append('div')
               .text(function(d) {
                   return d.key + ' ' + d.values.adjudicaciones + ' ' + d.values.money['$'];
               });
         
             
             console.info(by_ministerio);
             
         });
         
        </script>
    </body>
</html>   
